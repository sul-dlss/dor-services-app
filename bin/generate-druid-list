#!/usr/bin/env ruby
# frozen_string_literal: true

require_relative '../config/environment'
require 'set'

if ARGV.length != 1
  puts 'Usage: bin/generate-druid-list <SAMPLE_SIZE>'
  exit(false)
end

sample_size = Integer(ARGV[0])
REQUEST_SIZE = 250

druids = Set.new

druids.merge(File.read('druids.txt').split) if File.exist?('druids.txt')

while druids.length < sample_size
  results = ActiveFedora::SolrService.query('*:*', sort: 'random asc', fl: 'id', rows: REQUEST_SIZE, fq: '-has_model_ssim:"info:fedora%2Fafmodel:Part"')
  results.each { |r| druids << r['id'] }
  puts "Retrieved #{druids.length} druids"
  sleep(1)
end

File.open('druids.txt', 'w') do |file|
  druids.to_a.take(sample_size).each do |druid|
    file.write("#{druid}\n")
  end
end
