#!/usr/bin/env ruby
# frozen_string_literal: true

require_relative '../config/environment'
require_relative '../lib/fedora_archiver'
require 'tty-progressbar'

options = { input: 'druids.txt', archive: 'archive' }

parser = OptionParser.new do |option_parser|
  option_parser.banner = 'Usage: bin/archive-fedora [options]'
  option_parser.on('-iFILENAME', '--input FILENAME', String, 'File containing list of druids (instead of druids.txt).')
  option_parser.on('-dDRUIDS', '--druids DRUIDS', Array, 'List of druids (instead of druids.txt).')
  option_parser.on('-aDIRECTORY', '--archive DIRECTORY', String, 'Directory to write archived versions to (instead of archive).')
  option_parser.on('-l', '--lenient', 'Log and ignore error messages from Fedora')
  option_parser.on('-h', '--help', 'Displays help.') do
    puts option_parser
    exit
  end
end

Rails.logger = ActiveSupport::Logger.new('archive-fedora.log')
Rails.logger.formatter = proc do |severity, time, _, msg|
  "#{time.strftime('%Y-%m-%d %H:%M:%S')} - #{severity} - #{msg}\n"
end
Rails.logger.datetime_format = '%Y-%m-%d %H:%M:%S'

parser.parse!(into: options)
druids = options[:druids] || File.read(options[:input]).split

bar = TTY::ProgressBar.new(
  'Archiving [:bar] (:percent (:current/:total), rate: :rate/s, :elapsed total, ETA: :eta_time)',
  bar_format: :burger,
  total: druids.length
)

archiver = FedoraArchiver.new(
  druids:,
  archive_dir: options[:archive],
  lenient: options[:lenient]
)

archiver.run do
  bar.advance
end
