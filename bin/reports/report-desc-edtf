#!/usr/bin/env ruby
# frozen_string_literal: true

require_relative '../../config/environment'
require_relative '../../lib/report'

date_els = %w[
  dateCreated
  dateIssued
  dateCaptured
  dateValid
  dateModified
  copyrightDate
  dateOther
].freeze

formats = [
  /^-?\d{4}$/,                                               # 1997 or -1997
  /^\d{4}-\d{2}$/,                                           # 1997-05
  /^\d{4}-\d{2}-\d{2}$/,                                     # 1997-07-16
  /^\d{4}-\d{2}-\d{2}T\d{2}:\d{2}\+\d{2}:\d{2}$/,            # 1997-07-16T19:20+01:00
  /^\d{4}-\d{2}-\d{2}T\d{2}:\d{2}:\d{2}\+\d{2}:\d{2}$/,      # 1997-07-16T19:20:30+01:00
  /^\d{4}-\d{2}-\d{2}T\d{2}:\d{2}:\d{2}\.\d+\+\d{2}:\d{2}$/  # 1997-07-16T19:20:30.123+01:00
]

Report.new(name: 'desc-edtf', dsids: ['descMetadata']).run do |ng_xml|
  errors = []

  date_els.each do |el_name|
    ng_xml.xpath("//mods:#{el_name}[@encoding='edtf']", mods: MODS_NS).each do |el|
      # at least one of the formats must match or else we've found an error
      errors.push(el.content) unless formats.map { |format| format.match? el.content }.any?
    end
  end

  if errors.empty?
    false
  else
    errors.join(';')
  end
end
